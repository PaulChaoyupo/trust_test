<!-- 修正版 result.html 總結邏輯 -->
<script type="module">
import roleNameMap from './role_name_map.js';

const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('id');

if (!userId) {
  document.body.innerHTML = "<h3 class='text-center text-red-600 mt-10'>⚠️ 缺少識別碼，請從測驗頁面進入</h3>";
} else {
  fetch(`https://wnbvamrjoydduriwaetd.supabase.co/rest/v1/results?ID=eq.${userId}`, {
    headers: {
      'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduYnZhbXJqb3lkZHVyaXdhZXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxODQ4MjEsImV4cCI6MjA2MTc2MDgyMX0.AT_f5N-Kctcbkns47PyYurHxP9Z2ktRtbGgpyaMe4Oc',
      'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduYnZhbXJqb3lkZHVyaXdhZXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxODQ4MjEsImV4cCI6MjA2MTc2MDgyMX0.AT_f5N-Kctcbkns47PyYurHxP9Z2ktRtbGgpyaMe4Oc`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data || data.length === 0) {
      document.body.innerHTML = "<h3 class='text-center text-red-600 mt-10'>⚠️ 找不到你的測驗結果</h3>";
      return;
    }
    const user = data[0];
    if (typeof user.scores === 'string') user.scores = JSON.parse(user.scores);
    analyze(user);
  });
}

function analyze(user) {
  document.getElementById("basicInfo").innerText = `${user.name || '匿名使用者'}｜${user.date}`;

  const dims = ['team', 'execution', 'creativity', 'workstyle', 'awareness'];
  const dimNames = {
    team: '人際互動',
    execution: '積極行動',
    creativity: '靈感創造',
    workstyle: '慣性模式',
    awareness: '自我察覺'
  };

  const scores = user.scores;
  const avgScores = {};

  dims.forEach((key, idx) => {
    const vals = scores.slice(idx * 5, (idx + 1) * 5);
    avgScores[key] = vals.reduce((a, b) => a + b, 0) / vals.length;
  });

  const sortedDims = Object.entries(avgScores).sort((a, b) => b[1] - a[1]);
  const [highKey, lowKey] = [sortedDims[0][0], sortedDims[sortedDims.length - 1][0]];

  // 角色名稱 + 圖片
  const roleKey = `${highKey}_${lowKey}`;
  const roleName = roleNameMap[roleKey] || '個人化角色';
  document.getElementById('roleTitle').innerText = roleName;
  document.getElementById('roleImage').src = `character_${highKey}_${lowKey}.png`;

  // 進度條渲染
  dims.forEach(dim => {
    const percent = Math.round((avgScores[dim] / 6) * 100);
    const barBlock = document.createElement('div');
    barBlock.innerHTML = `
      <div class="flex justify-between mb-1">
        <span class="text-base font-medium text-gray-700">${dimNames[dim]}</span>
        <span class="text-sm text-gray-500">${percent}%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
        <div class="bg-blue-600 h-4 rounded-full" style="width: ${percent}%;"></div>
      </div>
      <div id="${dim}-desc" class="text-gray-600 text-sm italic">載入中...</div>
    `;
    document.getElementById('progressBars').appendChild(barBlock);

    let level = percent >= 70 ? 'high' : (percent >= 40 ? 'medium' : 'low');
    fetch(`${dim}_user.html`)
      .then(r => r.text())
      .then(t => {
        const temp = document.createElement('div');
        temp.innerHTML = t;
        const desc = temp.querySelector(`#${dim}-bar-${level}`);
        document.getElementById(`${dim}-desc`).innerHTML = desc ? desc.innerHTML : '（找不到敘述）';
      });
  });

  // ✅ 總結敘述自動抓取組合
  const awarenessGap = Math.abs(avgScores['awareness'] - ((scores[20] + scores[21] + scores[22]) / 3));
  let awarenessLevel = awarenessGap < 0.5 ? 'high' : (awarenessGap < 1 ? 'medium' : 'low');

  Promise.all([
    fetch(`${highKey}_user.html`).then(r => r.text()),
    fetch(`${lowKey}_user.html`).then(r => r.text()),
    fetch(`awareness_level.html`).then(r => r.text())
  ]).then(([highText, lowText, awarenessText]) => {
    const highTemp = document.createElement('div');
    const lowTemp = document.createElement('div');
    const awarenessTemp = document.createElement('div');

    highTemp.innerHTML = highText;
    lowTemp.innerHTML = lowText;
    awarenessTemp.innerHTML = awarenessText;

    const highContent = highTemp.querySelector(`#${highKey}-high`);
    const lowContent = lowTemp.querySelector(`#${lowKey}-low`);
    const awarenessContent = awarenessTemp.querySelector(`#awareness-${awarenessLevel}`);

    const finalHTML = `
      <div>
        <h4 class="font-semibold text-indigo-700 mb-2">高分構面 - ${dimNames[highKey]}</h4>
        <div>${highContent ? highContent.innerHTML : '（找不到高分敘述）'}</div>
        <h4 class="font-semibold text-indigo-700 mt-4 mb-2">低分構面 - ${dimNames[lowKey]}</h4>
        <div>${lowContent ? lowContent.innerHTML : '（找不到低分敘述）'}</div>
        <h4 class="font-semibold text-indigo-700 mt-4 mb-2">自我察覺</h4>
        <div>${awarenessContent ? awarenessContent.innerHTML : '（找不到自我察覺敘述）'}</div>
      </div>
    `;
    document.querySelector('#summaryBlock > div').innerHTML = finalHTML;
  });
}
</script>
