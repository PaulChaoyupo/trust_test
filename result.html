<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>測驗結果</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
<div class="max-w-3xl mx-auto p-6">
  <h2 class="text-3xl font-bold text-center text-blue-700 mb-4">你的測驗結果分析</h2>
  <p id="basicInfo" class="text-center text-gray-600 mb-6">姓名 / 日期</p>
  <div class="bg-white rounded shadow p-4 mb-6">
    <canvas id="radarChart" class="w-full h-64"></canvas>
  </div>
  <div id="highBlock" class="bg-white rounded shadow p-4 mb-4">
    <h3 class="text-xl font-semibold mb-2 text-indigo-700">高分構面</h3>
    <div>載入中...</div>
  </div>
  <div id="midBlock" class="bg-white rounded shadow p-4 mb-4">
    <h3 class="text-xl font-semibold mb-2 text-indigo-700">次高分構面</h3>
    <div>載入中...</div>
  </div>
  <div id="lowBlock" class="bg-white rounded shadow p-4 mb-4">
    <h3 class="text-xl font-semibold mb-2 text-indigo-700">低分構面</h3>
    <div>載入中...</div>
  </div>
  <div id="awarenessBlock" class="bg-white rounded shadow p-4">
    <h3 class="text-xl font-semibold mb-2 text-indigo-700">自覺層級分析</h3>
    <div>載入中...</div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://wnbvamrjoydduriwaetd.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduYnZhbXJqb3lkZHVyaXdhZXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxODQ4MjEsImV4cCI6MjA2MTc2MDgyMX0.AT_f5N-Kctcbkns47PyYurHxP9Z2ktRtbGgpyaMe4Oc';
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('id');

if (!userId) {
  document.body.innerHTML = "<h3 class='text-center text-red-600 mt-10'>⚠️ 缺少識別碼，請從測驗頁面進入</h3>";
} else {
  fetch(`${SUPABASE_URL}/rest/v1/results?id=eq.${userId}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Authorization': `Bearer ${SUPABASE_API_KEY}` }
  })
  .then(res => res.json())
  .then(data => {
    if (!data || data.length === 0) {
      document.body.innerHTML = "<h3 class='text-center text-red-600 mt-10'>⚠️ 找不到你的測驗結果</h3>";
      return;
    }
    const user = data[0];
    try {
      if (typeof user.scores === 'string') {
        user.scores = JSON.parse(user.scores);
      } else if (!Array.isArray(user.scores)) {
        throw new Error("scores 格式不正確");
      }
      analyze(user);
    } catch (e) {
      console.error("❌ scores 解析失敗", e);
      document.body.innerHTML = "<h3 class='text-center text-red-600 mt-10'>⚠️ 資料格式錯誤</h3>";
    }
})
  .catch(() => {
    document.body.innerHTML = "<h3 class='text-center text-red-600 mt-10'>⚠️ 無法讀取資料</h3>";
  });
}

function analyze(user) {
  document.getElementById("basicInfo").innerText = `${user.name || '匿名使用者'}｜${user.date}`;

  const dimMap = {
    "團隊展現": { key: "team", idxs: [0,1,2,3,4] },
    "執行能力": { key: "execution", idxs: [5,6,7,8,9] },
    "創意展現": { key: "creativity", idxs: [10,11,12,13,14] },
    "工作風格": { key: "workstyle", idxs: [15,16,17,18,19] },
    "自我認知": { key: "awareness", idxs: [20,21,22,23,24] },
    "一致性": { key: "consistency", idxs: [25,26,27,28,29,30] }
  };
  const MAX_SCORE = 6;
  const weighted = {}, percent = {};
  Object.entries(dimMap).forEach(([dim, { idxs }]) => {
    const vals = idxs.map(i => user.scores[i]);
    const avg = vals.reduce((a,b) => a+b,0)/vals.length;
    weighted[dim] = avg;
    percent[dimMap[dim].key] = Math.round((avg/MAX_SCORE)*100);
  });

  const selfAvg = dimMap['自我認知'].idxs.slice(0,3).map(i=>user.scores[i]).reduce((a,b)=>a+b,0)/3;
  const otherAvg = dimMap['自我認知'].idxs.slice(3).map(i=>user.scores[i]).reduce((a,b)=>a+b,0)/2;
  const awarenessGap = Math.abs(selfAvg - otherAvg);
  const awarenessLevel = awarenessGap<0.5?'high':(awarenessGap<1?'medium':'low');

  const consistencyAvg = dimMap['一致性'].idxs.map(i=>user.scores[i]).reduce((a,b)=>a+b,0)/6;
  const suspicious = consistencyAvg>4.5;

  const sorted = Object.entries(weighted).filter(([k])=>k!=='一致性').sort((a,b)=>b[1]-a[1]);
  const [highDim, midDim, lowDim] = [sorted[0][0], sorted[1][0], sorted[sorted.length-1][0]].map(d=>dimMap[d].key);

  drawChart(Object.keys(dimMap).filter(d=>d!=='一致性'), Object.keys(dimMap).filter(d=>d!=='一致性').map(d=>percent[dimMap[d].key]));

  loadSection(highDim, 'high', 'highBlock');
  loadSection(midDim, 'second', 'midBlock');
  loadSection(lowDim, 'low', 'lowBlock');
  loadHTML('awarenessBlock', `self_awareness_${awarenessLevel}_${highDim}_${midDim}.html`);

  if(suspicious){
    document.getElementById('awarenessBlock').innerHTML += `<div class="text-red-600 font-bold mt-2">⚠️ 注意：填答一致性偏高，請小心解讀結果</div>`;
  }
}

function drawChart(labels, data){
  new Chart(document.getElementById("radarChart"), {
    type:'radar',
    data:{labels,datasets:[{label:'構面分數(%)',data,backgroundColor:'rgba(33,111,163,0.2)',borderColor:'#2170a3',pointBackgroundColor:'#2170a3'}]},
    options:{
      scales:{r:{min:0,max:100,ticks:{stepSize:20,callback:v=>`${v}%`,backdropColor:'transparent',font:{size:14}},pointLabels:{font:{size:16}}}},
      plugins:{legend:{display:false}},
      responsive:true,maintainAspectRatio:false
    }
  });
}

async function loadSection(dim,section,blockId){
  const path=`${dim}.html`;
  const pct=window.chartPercentages?window.chartPercentages[dim]:0;
  try{
    const res=await fetch(path);
    const html=await res.text();
    const temp=document.createElement('div');
    temp.innerHTML=html;
    const sec=temp.querySelector(`#${dim}-${section}`);
    document.getElementById(blockId).innerHTML=sec?`<h3 class="text-lg font-semibold mb-2">${dim}-${section} <span>${pct}%</span></h3><div>${sec.innerHTML}</div>`:`❌ ${dim}-${section} 未找到`;
  }catch{
    document.getElementById(blockId).innerHTML=`❌ 無法載入 ${path}`;
  }
}

function loadHTML(id,path){
  fetch(path)
    .then(r=>r.ok?r.text():Promise.reject())
    .then(t=>document.getElementById(id).innerHTML=`<div>${t}</div>`)
    .catch(()=>document.getElementById(id).innerHTML=`❌ 無法載入 ${path}`);
}
</script>
</body>
</html>
