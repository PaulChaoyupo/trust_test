<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Talent Sketch 才能素描後台</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      font-size: clamp(15px, 2.5vw, 18px);
      line-height: 1.6;
      word-break: break-word;
    }
    h2 {
      font-size: clamp(18px, 3vw, 24px);
      color: #333;
      line-height: 1.4;
    }
    h3 {
      font-size: clamp(17px, 2.5vw, 22px);
      color: #333;
      line-height: 1.4;
    }
    section {
      margin-bottom: 20px;
    }
    select, input[type="date"] {
      margin: 0 10px;
      padding: 5px;
      font-size: 1em;
    }
    .block {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 100%;
      overflow-x: auto;
    }
    .card-text {
      font-size: clamp(15px, 2.2vw, 18px);
      line-height: 1.7;
      word-break: break-word;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .button-group button {
      font-size: clamp(14px, 2.5vw, 18px);
      padding: 0.6em 1.2em;
      border: none;
      border-radius: 8px;
      background-color: #1d3557;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .button-group button:hover {
      background-color: #457b9d;
    }
    body.reading-mode .card-text { font-size: 1.8rem; line-height: 2; }
    body.dark-mode { background-color: #1e1e1e; color: #e0e0e0; }
    body.dark-mode .block { background-color: #2a2a2a; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    body.dark-mode h2, body.dark-mode h3, body.dark-mode label { color: #f0f0f0; }
    body.dark-mode select, body.dark-mode input[type="date"] { background-color: #333; color: #f0f0f0; border: 1px solid #555; }
    body.dark-mode #toggleThemeBtn { background: #444; color: #fff; border: 1px solid #666; }
  </style>
</head>
<body>
<h2>分析儀表板</h2>
<section>
  <label for="dateSelector">選擇日期：</label>
  <input type="date" id="dateSelector">
  <select id="userSelector" disabled>
    <option>請先選擇日期</option>
  </select>
</section>
<div class="button-group">
  <button id="toggleThemeBtn">切換深色模式</button>
  <button id="toggleReadingMode">切換閱讀模式</button>
</div>
<div class="block"><canvas id="radarChart" width="400" height="400"></canvas></div>
<div class="block" id="highBlock"><h3>高分構面分析</h3><div id="highContent" class="card-text"></div></div>
<div class="block" id="midBlock"><h3>次高分構面分析</h3><div id="midContent" class="card-text"></div></div>
<div class="block" id="lowBlock"><h3>低分構面分析</h3><div id="lowContent" class="card-text"></div></div>
<div class="block" id="awarenessBlock"><h3>自覺層級分析</h3><div id="awarenessContent" class="card-text"></div></div>
<script src="dashboard_logic.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const role = localStorage.getItem("role");
  const email = localStorage.getItem("email");
  const department = localStorage.getItem("department");
  const dateInput = document.getElementById("dateSelector");
  const nameSelect = document.getElementById("userSelector");

  dateInput.addEventListener("change", async () => {
    const selectedDate = dateInput.value;
    nameSelect.innerHTML = '<option>載入中...</option>';

    const { data, error } = await fetch(`https://wnbvamrjoydduriwaetd.supabase.co/rest/v1/results?select=name,department,date&date=eq.${selectedDate}`, {
      headers: {
        apikey: 'YOUR_API_KEY',
        Authorization: 'Bearer YOUR_API_KEY'
      }
    }).then(r => r.json());

    if (!data || !data.length) {
      nameSelect.innerHTML = '<option>查無資料</option>';
      return;
    }

    const filtered = role === "admin"
      ? data
      : data.filter(d => d.department === department);

    const names = [...new Set(filtered.map(d => d.name))].sort();
    nameSelect.innerHTML = '<option value="">請選擇姓名</option>';
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      nameSelect.appendChild(opt);
    });

    nameSelect.disabled = false;

    // 當 admin 選完姓名自動載入資料（manager 手動觸發）
    if (role === 'admin' || role === 'supervisor') {
      nameSelect.addEventListener("change", () => {
        const selected = nameSelect.value;
        if (selected) loadUserData(selected);
      });
    }
  });

  // 若為 manager 直接載入自己
  if (role === 'manager') {
    const { data: selfData } = await fetch(`https://wnbvamrjoydduriwaetd.supabase.co/rest/v1/results?select=name&email=eq.${email}`, {
      headers: {
        apikey: 'YOUR_API_KEY',
        Authorization: 'Bearer YOUR_API_KEY'
      }
    }).then(r => r.json());

    if (selfData && selfData.length) {
      const selfName = selfData[0].name;
      const opt = document.createElement("option");
      opt.value = selfName;
      opt.textContent = selfName;
      nameSelect.appendChild(opt);
      nameSelect.value = selfName;
      loadUserData(selfName);
      nameSelect.disabled = true;
    }
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  if (window.innerWidth < 400) {
    alert('提示：為了獲得更佳閱讀體驗，建議您將手機橫向瀏覽。');
  }
  const toggleBtn = document.getElementById('toggleReadingMode');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('reading-mode');
    });
  }
  const themeBtn = document.getElementById('toggleThemeBtn');
  if (themeBtn) {
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('prefersDarkMode', document.body.classList.contains('dark-mode'));
    });
  }
  const prefersDark = localStorage.getItem('prefersDarkMode') === 'true';
  if (prefersDark) {
    document.body.classList.add('dark-mode');
  }
});
</script>
<!-- 🔙 返回首頁 or 登出 -->
<div id="navButton" style="position: fixed; bottom: 24px; right: 24px; z-index: 999; background-color: #457b9d; color: white; padding: 0.8rem 1.2rem; border-radius: 999px; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: none;"></div>
<script>
  const role = localStorage.getItem('role');
  const email = localStorage.getItem('email');
  const navBtn = document.getElementById('navButton');

  if (!email || !role) window.location.href = 'result_selector.html';

  if (role === 'admin' || role === 'supervisor') {
    navBtn.textContent = '🔙 返回首頁';
    navBtn.style.display = 'block';
    navBtn.onclick = () => window.location.href = 'result_selector.html';
  } else if (role === 'manager') {
    navBtn.textContent = '登出系統';
    navBtn.style.display = 'block';
    navBtn.onclick = () => {
      localStorage.clear();
      window.location.href = 'result_selector.html';
    };
  }
</script>
</body>
</html>
