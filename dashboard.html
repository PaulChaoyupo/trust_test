
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboardï½œæ¸¬é©—åˆ†æå¾Œå°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: auto;
      background: #f1f3f5;
      padding: 1.5rem;
      max-width: 1024px;
      color: #333;
    }
    h2, h3 { color: #1d3557; }
    section {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    select {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border-radius: 6px;
    }
    canvas { max-width: 100%; }
    @media (max-width: 600px) {
      h2 { font-size: 1.25rem; }
      section { padding: 1rem; }
    }
  </style>
</head>
<body>
  <h2>å—æ¸¬è€…åˆ†æå¾Œå°ï½œDashboard</h2>

  <section>
    <label for="dateSelector">é¸æ“‡æ¸¬é©—æ—¥æœŸï¼š</label>
    <select id="dateSelector"></select>
    <label for="userSelector">é¸æ“‡å—æ¸¬è€…å§“åï¼š</label>
    <select id="userSelector" disabled></select>
  </section>

  <div id="analysisArea" style="display:none">
    <section><h3>ğŸ“Š äº”æ§‹é¢é›·é”åœ–</h3><canvas id="radarChart" height="300"></canvas></section>
    <section><h3>ğŸ“˜ é›·é”åœ–æ•´é«”è§£èªª</h3><div id="radarBlock">-</div></section>
    <section><h3>ğŸ” ä¸»å°æ§‹é¢æ¨¡æ“¬æ•˜è¿°</h3><div id="personaBlock">-</div></section>
    <section><h3>ğŸŒŸ é«˜åˆ†çµ„åˆå„ªå‹¢èªªæ˜</h3><div id="advBlock">-</div></section>
    <section><h3>âš ï¸ ä½åˆ†æ§‹é¢é¢¨éšªå»ºè­°</h3><div id="riskBlock">-</div></section>
    <section><h3>ğŸ§  è‡ªè¦ºç¨‹åº¦åˆ†æ</h3><div id="awarenessBlock">-</div></section>
  </div>

  <script>
    const dimensionMap = {
      "åœ˜éšŠå±•ç¾": [0, 1, 32],
      "è‡ªæˆ‘èªçŸ¥": [2, 6, 8, 9, 10, 11, 26, 27, 28, 29, 30, 32, 34],
      "åŸ·è¡Œèƒ½åŠ›": [4, 5, 19, 20, 21],
      "å‰µæ„å±•ç¾": [12, 13, 14, 17, 18],
      "å·¥ä½œé¢¨æ ¼": [3, 7, 15, 16, 31, 33]
    };

    function calcAvg(scores) {
      const result = {};
      for (const [key, idxs] of Object.entries(dimensionMap)) {
        result[key] = parseFloat((idxs.reduce((sum, i) => sum + scores[i], 0) / idxs.length).toFixed(2));
      }
      return result;
    }

    function drawRadar(avg) {
      new Chart(document.getElementById("radarChart"), {
        type: "radar",
        data: {
          labels: Object.keys(avg),
          datasets: [{
            label: "äº”æ§‹é¢åˆ†æ•¸",
            data: Object.values(avg),
            backgroundColor: "rgba(33,111,163,0.2)",
            borderColor: "#2170a3",
            pointBackgroundColor: "#2170a3"
          }]
        },
        options: {
          scales: { r: { min: 1, max: 3, ticks: { stepSize: 0.5 } } },
          plugins: { legend: { display: false } }
        }
      });
    }

    async function loadText(id, path) {
      try {
        const html = await fetch(path).then(res => res.text());
        document.getElementById(id).innerHTML = html;
      } catch {
        document.getElementById(id).innerText = `æ‰¾ä¸åˆ° ${path}`;
      }
    }

    const dataset = JSON.parse(localStorage.getItem("trust_test_dataset") || "[]");
    const dateSel = document.getElementById("dateSelector");
    const nameSel = document.getElementById("userSelector");

    const dates = [...new Set(dataset.map(d => d.date))];
    dates.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d; opt.text = d;
      dateSel.appendChild(opt);
    });

    dateSel.onchange = () => {
      nameSel.innerHTML = "<option value=''>è«‹é¸æ“‡</option>";
      nameSel.disabled = false;
      const filtered = dataset.filter(d => d.date === dateSel.value);
      filtered.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.text = d.name;
        nameSel.appendChild(opt);
      });

      nameSel.onchange = () => {
        const entry = filtered[nameSel.value];
        if (!entry) return;
        const avg = calcAvg(entry.scores);
        const sorted = Object.entries(avg).sort((a, b) => b[1] - a[1]);
        const top = sorted[0][0];
        const high = sorted.filter(([_, v]) => v >= 2.6).map(([k]) => k);
        const low = sorted.filter(([_, v]) => v < 2.1).map(([k]) => k);

        document.getElementById("analysisArea").style.display = "block";
        drawRadar(avg);
        loadText("radarBlock", `radar_${top}.html`);
        loadText("personaBlock", `persona_${top}.html`);

        const advKey = high.slice(0, 3).join("_") || high.slice(0, 2).join("_");
        loadText("advBlock", `strength_${advKey}_high.html`);

        const riskDiv = document.getElementById("riskBlock");
        riskDiv.innerHTML = "";
        low.forEach(k => {
          const div = document.createElement("div");
          riskDiv.appendChild(div);
          fetch(`risk_${k}_low.html`)
            .then(res => res.text())
            .then(html => div.innerHTML = html)
            .catch(() => div.innerText = `æ‰¾ä¸åˆ°é¢¨éšª risk_${k}_low.html`);
        });

        const selfQ = [2, 6, 27, 30, 32, 33, 34];
        const rev = [0, 1]; // æ¨¡æ“¬åå–†é¡Œä½ç½®
        const likert = selfQ.map(i => entry.scores[i]);
        const revSum = rev.map(i => entry.scores[i]).reduce((a, b) => a + b, 0);
        const avgLikert = likert.reduce((a, b) => a + b, 0) / likert.length;

        let bias = "";
        if (avgLikert >= 2.6 && revSum <= 3) {
          bias = "âš ï¸ é«˜è‡ªè©•ä½†åå–†çŸ›ç›¾ï¼Œå¯èƒ½å‡ºç¾é«˜ä¼°å‚¾å‘";
        } else if (avgLikert <= 1.5 && revSum >= 5) {
          bias = "âš ï¸ ä½è‡ªè©•ä½†åå–†åˆç†ï¼Œå¯èƒ½éåº¦å£“æŠ‘";
        } else {
          bias = "âœ… è‡ªè©•èˆ‡å…§åœ¨ä¸€è‡´æ€§è‰¯å¥½";
        }
        document.getElementById("awarenessBlock").innerText = bias;
      };
    };
  </script>
</body>
</html>
