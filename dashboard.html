<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Dashboard è³‡æ–™ç®¡ç†å·¥å…· + åˆ†æ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>å¾Œå°åˆ†æé  + è³‡æ–™ç®¡ç†å·¥å…·</h2>
  <section>
    <button onclick="exportData()">ğŸ“¥ åŒ¯å‡ºæ¸¬é©—è³‡æ–™</button>
    <button onclick="clearData()">â™»ï¸ æ¸…é™¤æ¸¬é©—è³‡æ–™</button>
    <input type="file" id="importFile" />
    <button onclick="importData()">ğŸ”„ é‚„åŸè³‡æ–™</button>
  </section>
  <section>
    <label for="dateSelector">é¸æ“‡æ¸¬é©—æ—¥æœŸï¼š</label>
    <input type="date" id="dateSelector" />
    <label for="userSelector">é¸æ“‡å—æ¸¬è€…å§“åï¼š</label>
    <select id="userSelector" disabled></select>
  </section>
  <section><canvas id="radarChart" height="300"></canvas></section>
  <section><div id="personaBlock">ä¸»å°æ§‹é¢åˆ†æ</div></section>
  <section><div id="advBlock">å„ªå‹¢çµ„åˆåˆ†æ</div></section>
  <section><div id="riskBlock">ä½åˆ†é¢¨éšªåˆ†æ</div></section>
  <section><div id="awarenessBlock">è‡ªè¦ºç¨‹åº¦åˆ†æ</div></section>
<script>
let radarChart;
const SUPABASE_URL = 'https://wnbvamrjoydduriwaetd.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduYnZhbXJqb3lkZHVyaXdhZXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxODQ4MjEsImV4cCI6MjA2MTc2MDgyMX0.AT_f5N-Kctcbkns47PyYurHxP9Z2ktRtbGgpyaMe4Oc';

fetch(`${SUPABASE_URL}/rest/v1/results?select=*`, {
  headers: {
    'apikey': SUPABASE_API_KEY,
    'Authorization': `Bearer ${SUPABASE_API_KEY}`
  }
})
.then(response => response.json())
.then(data => {
  const dateInput = document.getElementById("dateSelector");

  dateInput.addEventListener('change', () => {
    const selectedDate = dateInput.value;
    const oldUserSel = document.getElementById("userSelector");
    const newUserSel = oldUserSel.cloneNode(true);
    oldUserSel.parentNode.replaceChild(newUserSel, oldUserSel);
    newUserSel.innerHTML = "<option value=''>è«‹é¸æ“‡</option>";
    newUserSel.disabled = false;

    const filtered = data.filter(d => d.date.substring(0,10) === selectedDate);
    filtered.forEach((d, i) => {
      const o = document.createElement("option");
      o.value = i;
      o.text = d.name;
      newUserSel.appendChild(o);
    });

    newUserSel.addEventListener('change', () => {
      const e = filtered[newUserSel.value];
      if (!e) return;

      try {
        e.scores = typeof e.scores === 'string' ? JSON.parse(e.scores) : e.scores;
      } catch {
        console.error("âŒ scores JSON è§£æå¤±æ•—", e.scores);
        return;
      }

      const dimMap = {
        "åœ˜éšŠå±•ç¾": [0,1,32],
        "è‡ªæˆ‘èªçŸ¥": [2,6,8,9,10,11,26,27,28,29,30,32,34],
        "åŸ·è¡Œèƒ½åŠ›": [4,5,19,20,21],
        "å‰µæ„å±•ç¾": [12,13,14,17,18],
        "å·¥ä½œé¢¨æ ¼": [3,7,15,16,31,33]
      };
      const dimKeyMap = {
        "åœ˜éšŠå±•ç¾": "team",
        "è‡ªæˆ‘èªçŸ¥": "awareness",
        "åŸ·è¡Œèƒ½åŠ›": "execution",
        "å‰µæ„å±•ç¾": "creativity",
        "å·¥ä½œé¢¨æ ¼": "workstyle"
      };
      const avg = {};
      for (const [k, i] of Object.entries(dimMap)) {
        avg[k] = i.reduce((s, n) => s + e.scores[n], 0) / i.length;
      }
      const avgKey = Object.fromEntries(Object.entries(avg).map(([k, v]) => [dimKeyMap[k], v]));
      const sorted = Object.entries(avgKey).sort((a, b) => b[1] - a[1]);
      const top = sorted[0][0];
      const high = sorted.filter(([_, v]) => v >= 2.6).map(([k]) => k);
      const low = sorted.filter(([_, v]) => v < 2.1).map(([k]) => k);
      const advKey = high.length ? high.slice(0,3).sort().join("_") : top;

      if (radarChart) radarChart.destroy();
      radarChart = new Chart(document.getElementById("radarChart"), {
        type: 'radar',
        data: { labels: Object.keys(avg), datasets: [{ label: 'æ§‹é¢åˆ†æ•¸', data: Object.values(avgKey), backgroundColor: 'rgba(33,111,163,0.2)', borderColor: '#2170a3', pointBackgroundColor: '#2170a3' }] },
        options: {
          scales: { r: { min: 1, max: 3, ticks: { stepSize: 0.5 } } },
          plugins: { legend: { display: false } }
        }
      });

      function loadText(id, path) {
        fetch(path)
          .then(r => r.ok ? r.text() : Promise.reject())
          .then(t => document.getElementById(id).innerHTML = t)
          .catch(() => document.getElementById(id).innerHTML = `âŒ ç„¡æ³•è¼‰å…¥ ${path}`);
      }
      loadText("personaBlock", `persona_${top}.html`);
      loadText("advBlock", `strength_${advKey}_high.html`);

      const riskDiv = document.getElementById("riskBlock");
      riskDiv.innerHTML = '';
      const lowLimited = sorted.slice(-2).map(([k]) => k);
      lowLimited.forEach(k => {
        const d = document.createElement("div");
        riskDiv.appendChild(d);
        const riskKey = `risk_${k}_low.html`;
        fetch(riskKey)
          .then(r => { if (!r.ok) throw new Error(); return r.text(); })
          .then(h => d.innerHTML = h)
          .catch(() => d.innerHTML = `âŒ ç„¡æ³•è¼‰å…¥ ${riskKey}`);
      });

      const awarenessAvg = [2,6,8,9,10,11,26,27,28,29,30,32,34].reduce((sum, i) => sum + e.scores[i], 0) / 13;
      const awarenessLevel = awarenessAvg < 2.1 ? 'low' : awarenessAvg >= 2.6 ? 'high' : 'balanced';
      loadText("awarenessBlock", `awareness_${awarenessLevel}.html`);
    });
  });
})
.catch(err => console.error("âŒ è®€å– Supabase è³‡æ–™å¤±æ•—", err));
</script>
</body>
</html>
